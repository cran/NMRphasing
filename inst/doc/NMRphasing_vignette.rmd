---
title: "NMRphasing"
author: "Aixiang Jiang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NMRphasing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# NMRphasing

NMRphasing is an R package designed for the correction of phase errors in NMR data. While its primary focus is on 1D NMR data, it can also be employed for 2D and 3D NMR data by processing one 1D NMR data file at a time.


## I. NMRphasing installation

First of all, please ensure that you have the R package MassSpecWavelet, which is a dependency for NMRphasing. You can install MassSpecWavelet using the following example code:

if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install("MassSpecWavelet")


Now, let's proceed to install NMRphasing from GitHub.

```{r eval = FALSE}
devtools :: install_github(repo = "ajiangsfu/NMRphasing",force = TRUE)  
## if you do not have old versions of NMRphasing, please remove force = TRUE
```

## II. Data format
The input data for NMRphasing can be in one of four formats:

1) A vector of absorption spectrum.
2) A complex vector.
3) A data matrix with two columns of spectrum data, where the first column represents the absorption spectrum, and the second column represents the dispersion spectrum.
4) A data frame with two columns of spectrum data, where the first column is for the absorption spectrum, and the second column is for the dispersion spectrum.

After installing NMRphasing, you can load a subset of example data from our multiple metabolite spike-in experiment using the following code snippet:

```{r}
library(NMRphasing)
data("fdat")
str(fdat)
```

In the code above, we load the dataset 'fdat' from the package. 'fdat$frequency_domain' represents the complex vector used in the following illustration, while 'freq' is utilized for plotting purposes. If your NMR data uses ppm values, you can substitute 'ppm' accordingly.


```{r dpi = 300}

## in order to make comparison, absorption part can be extracted
fdat$Observed_Absorption = Re(fdat$frequency_domain)

library(ggpubr)
p1 = ggplot(fdat, aes(x = ppm, y = Observed_Absorption)) +
      geom_line() + theme_bw() + labs(y = "Observed Absorption") +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
p1
```

The observed absorption spectrum without phase error correction looks very bad.

## III. Example Code
In this package, there are currently seven NMR phase error correction methods implemented. They are as follows: "SPC_DANM","NLS", "MPC_DANM", "MPC_EMP", "SPC_EMP", "SPC_AAM", and "SPC_DSM".

### 1. SPC_DANM
The "SPC_DANM" method employs the traditional single linear model approach for phase error correction but incorporates a new optimization function designed to minimize the difference between absolute area and net area.

```{r dpi = 300}

fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "SPC_DANM") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"),font.label =10,nrow = 2, ncol=1)

```

### 2. NLS

This is our new shrinkage method, which is the fastest phase error correction method since it does not involve any optimization step.


```{r dpi = 300}
fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "NLS") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"),font.label =10,nrow = 2, ncol=1)

```

### 3. MPC_DANM

This approach utilizes our new multiple linear model for phase error correction along with our optimization function designed to minimize the difference between absolute area and net area.

```{r dpi = 300}
fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "MPC_DANM") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"),font.label =10,nrow = 2, ncol=1)

```


### 4. MPC_EMP

This is to apply our new multiple linear model approach for phase error correction based on an existing optimization function: entropy minimization with negative peak penalty.

```{r dpi = 300}
fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "MPC_EMP") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"),font.label =10,nrow = 2, ncol=1)

```

### 5. SPC_EMP

This is an old phase error correction method based on the traditional single model approach targeting on an existing optimization function: entropy minimization with negative peak penalty.

```{r dpi = 300}
fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "SPC_EMP") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"),font.label =10,nrow = 2, ncol=1)

```

### 6. SPC_AAM

This is an old phase error correction method based on the traditional single model approach with an existing optimization function: absolute area minimization.

```{r dpi = 300}
fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "SPC_AAM") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"),font.label =10,nrow = 2, ncol=1)

```

### 7. SPC_DSM

This is an old phase error correction method based on the traditional single model approach with an existing optimization function: dispersion summation minimization.

```{r dpi = 300}
fdat$Phased_Absoprtion = NMRphasing(specDatIn = fdat$frequency_domain, method = "SPC_DSM") 

p2 = ggplot(fdat, aes(x = ppm, y = Phased_Absoprtion)) +
      geom_line() + theme_bw() + labs(y = "Phased Absoprtion") +
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggarrange(plotlist = list(p1,p2),labels = c("Before","After"), font.label =10,nrow = 2, ncol=1)

```

## IV. NMRphasing R package general information

Version: 1.0.1
Authors@R: c(
  person("Aixiang Jiang", role = c("aut", "cre", "cph"), 
         email = "aijiang@bccrc.ca",
         comment = c(ORCID = "0000-0002-6153-7595"))
)
Maintainer: Aixiang Jiang <aijiang@bccrc.ca>
Depends: R (>= 4.2.0),stats
Suggests: knitr, rmarkdown, ggpubr
VignetteBuilder: knitr
Imports: baseline, splines, MassSpecWavelet
Description:  There are three distinct approaches for phase error correction, they are: a single linear model with a choice of optimization functions, multiple linear models with optimization function choices and a shrinkage-based method. The methodology is based on our new algorithms and various references:
    Binczyk et al. (2015) <doi:10.1186/1475-925X-14-S2-S5>
    Chen et al. (2002) <doi:10.1016/S1090-7807(02)00069-1>
    de Brouwer (2009) <doi:10.1016/j.jmr.2009.09.017>
    DÅ¾akula (2000) <doi:10.1006/jmre.2000.2123>
    Ernst (1969) <doi:10.1016/0022-2364(69)90003-1>
    Liland et al. (2010) <doi:10.1366/000370210792434350>
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
RoxygenNote: 7.2.3



